name: æ’ç¨‹ï½œãƒ›ãƒ¯ã‚¤ãƒˆã‚¿ã‚¤ã‚¬ãƒ¼ã¨ãƒ–ãƒ©ãƒƒ

on:
  schedule:
    - cron: '0 * * * *'  # UTC 0~16é» = å°ç£æ™‚é–“ 8:00~00:00ï¼Œæ¯å°æ™‚ä¸€æ¬¡
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼ï¼ˆdebug ç”¨ï¼‰

permissions:
  contents: write

jobs:
  run-python-script:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL_WBTIGER }}

    steps:
      - name: Show schedule time
        run: date

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run wbtiger.py
        run: python python/wbtiger.py

      - name: Commit and push changes if needed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ“¦ åˆ—å‡º data/ æª”æ¡ˆï¼š"
          ls -al data || echo "âš ï¸ æ‰¾ä¸åˆ° data/ è³‡æ–™å¤¾"

          # è¨­å®š remote ä¸¦å…ˆ pull æœ€æ–°
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git pull --rebase

          updated=0

          for file in data/products_wbtiger.json data/notified_wbtiger.json; do
            if [ ! -f "$file" ]; then
              echo "ğŸ†• $file ä¸å­˜åœ¨ï¼Œå»ºç«‹ç©ºæª”æ¡ˆ..."
              mkdir -p "$(dirname "$file")"
              touch "$file"
              git add "$file"
              updated=1
            elif ! git diff --quiet -- "$file"; then
              echo "ğŸ“„ $file æœ‰è®Šæ›´ï¼ŒåŠ å…¥ commit"
              git add "$file"
              updated=1
            else
              echo "âœ… $file æ²’æœ‰è®Šæ›´ï¼Œç•¥é"
            fi
          done

          if [ "$updated" -eq 1 ]; then
            git commit -m "âœ… æ›´æ–° WBTiger ç›¸é—œè³‡æ–™"
            git push || (echo "âŒ push å¤±æ•—" && exit 1)
          else
            echo "âœ¨ æ²’æœ‰éœ€è¦ commit çš„è®Šæ›´"
          fi
